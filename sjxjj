<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>éšæœºå°å§å§è§†é¢‘</title>
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNTYiIGhlaWdodD0iMjU2IiB2aWV3Qm94PSIwIDAgMTYgMTYiPjxwYXRoIGZpbGw=" type="image/svg+xml">
    <style>
        :root {
            --theme-color: #ffc107; /* ä¸»é¢˜è‰² - é»„è‰² */
            --theme-color-dark: #e0a800;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body {
            height: 100%; width: 100%; overflow: hidden;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #000; touch-action: none;
        }
        
        .player-container {
            position: relative; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
        }
        
        .video-container {
            position: relative; width: 100vw; height: 100vh;
            overflow: hidden; background: #000; cursor: pointer;
        }
        
        .video-wrapper { width: 100%; height: 100%; }
        
        video {
            display: block; width: 100%; height: 100%;
            object-fit: cover; background: #000;
            /* å˜æ¢çš„åŸç‚¹è®¾ç½®ä¸ºä¸­å¿ƒ */
            transform-origin: center center;
            transition: transform 0.2s ease-out; /* For pinch-zoom */
        }
        
        video::-webkit-media-controls { display: none !important; }

        .controls {
            position: absolute; bottom: 80px; right: 10px; z-index: 20;
            display: flex; flex-direction: column; gap: 20px;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        .controls.visible { opacity: 1; pointer-events: auto; }
        
        button {
            background-color: var(--theme-color); color: #333; border: none;
            padding: 8px 12px; border-radius: 6px; cursor: pointer;
            font-size: 0.8rem; font-weight: bold; transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); user-select: none;
            min-width: 80px; text-align: center;
        }
        button:hover { transform: scale(1.05); }
        button:active { transform: scale(0.95); background-color: var(--theme-color-dark); }
        
        .loading {
            display: flex; align-items: center; justify-content: center;
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); z-index: 15;
        }
        
        .spinner {
            width: 60px; height: 60px; border: 5px solid rgba(255, 193, 7, 0.3);
            border-radius: 50%; border-top-color: var(--theme-color);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Settings & Source Modal Styles --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px);
            z-index: 100; display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: rgba(40, 40, 40, 0.9); padding: 20px; border-radius: 12px;
            width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; color: #fff;
            transform: scale(0.95); transition: transform 0.3s;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        
        .modal-list { list-style: none; margin-top: 15px; }
        .modal-list li {
            padding: 12px; border-bottom: 1px solid #444; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            transition: background-color 0.2s;
        }
        .modal-list li:hover { background-color: #333; }
        .modal-list li.active { color: var(--theme-color); font-weight: bold; }
        .modal-list li:last-child { border-bottom: none; }
        .delete-source-btn {
            background: #e74c3c; color: white; border: none; border-radius: 5px;
            padding: 4px 8px; font-size: 0.7rem;
        }

        .settings-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #444; }
        .settings-item:last-child { border-bottom: none; }
        .volume-slider { width: 60%; }
        #autoplayToggle.enabled { background-color: #28a745; color: white; }

        #addSourceForm { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        #addSourceForm input { padding: 10px; border-radius: 5px; border: 1px solid #555; background: #333; color: #fff; }
        #formActions { display: flex; gap: 10px; justify-content: flex-end; }
    </style>
</head>
<body>
    <div class="player-container">
        <div class="video-container" id="videoContainer">
            <div class="loading" id="loading"><div class="spinner"></div></div>
            <div class="video-wrapper" id="videoWrapper">
                <video id="videoPlayer" playsinline preload="auto"></video>
            </div>
        </div>
        <div class="controls" id="controls">
            <button id="changeSourceBtn">éšæœºæº</button>
            <button id="reloadBtn">ä¸‹ä¸€ä¸ª</button>
            <button id="settingsBtn">...</button>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal-content">
            <h3>è®¾ç½®</h3>
            <div class="settings-item">
                <span>ä¸‹è½½è§†é¢‘</span>
                <button id="downloadBtn">ä¸‹è½½</button>
            </div>
            <div class="settings-item">
                <span>éŸ³é‡</span>
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.05" value="1">
            </div>
            <div class="settings-item">
                <span>è‡ªåŠ¨è¿æ’­</span>
                <button id="autoplayToggle">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <!-- Source Modal -->
    <div class="modal-overlay" id="sourceModal">
        <div class="modal-content">
            <h3>é€‰æ‹©è§†é¢‘æº</h3>
            <ul class="modal-list" id="sourceList"></ul>
            <button id="openAddSourceFormBtn" style="margin-top: 15px; width: 100%;">æ·»åŠ æ–°æº</button>
            <form id="addSourceForm" style="display: none;">
                <input type="text" id="sourceNameInput" placeholder="æºåç§° (ä¾‹å¦‚: é«˜æ¸…å°å§å§)" required>
                <input type="url" id="sourceUrlInput" placeholder="æºURLåœ°å€" required>
                <div id="formActions">
                    <button type="button" id="cancelAddSourceBtn">å–æ¶ˆ</button>
                    <button type="submit">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            const videoPlayer = document.getElementById('videoPlayer');
            const videoContainer = document.getElementById('videoContainer');
            const controls = document.getElementById('controls');
            const reloadBtn = document.getElementById('reloadBtn');
            const changeSourceBtn = document.getElementById('changeSourceBtn');
            const settingsBtn = document.getElementById('settingsBtn');
            const settingsModal = document.getElementById('settingsModal');
            const downloadBtn = document.getElementById('downloadBtn');
            const volumeSlider = document.getElementById('volumeSlider');
            const autoplayToggle = document.getElementById('autoplayToggle');
            const loading = document.getElementById('loading');
            const sourceModal = document.getElementById('sourceModal');
            const sourceList = document.getElementById('sourceList');
            const openAddSourceFormBtn = document.getElementById('openAddSourceFormBtn');
            const addSourceForm = document.getElementById('addSourceForm');
            const cancelAddSourceBtn = document.getElementById('cancelAddSourceBtn');

            // --- State Variables ---
            let autoPlayEnabled = false;
            let currentSource = 'random';
            let controlsTimer;

            // --- Zoom & Pan State ---
            let scale = 1;
            let translateX = 0;
            let translateY = 0;
            let isDragging = false;
            let lastDragX, lastDragY;
            
            // --- Data ---
            const DEFAULT_SOURCES = [
                { name: 'hssp', url: 'http://api.xingchenfu.xyz/API/hssp.php' }, { name: 'wmsc', url: 'http://api.xingchenfu.xyz/API/wmsc.php' },
                { name: 'tianmei', url: 'http://api.xingchenfu.xyz/API/tianmei.php' }, { name: 'cdxl', url: 'http://api.xingchenfu.xyz/API/cdxl.php' },
                { name: 'yzxl', url: 'http://api.xingchenfu.xyz/API/yzxl.php' }, { name: 'rwsp', url: 'http://api.xingchenfu.xyz/API/rwsp.php' },
                { name: 'nvgao', url: 'http://api.xingchenfu.xyz/API/nvgao.php' }, { name: 'nvda', url: 'http://api.xingchenfu.xyz/API/nvda.php' },
                { name: 'ndym', url: 'http://api.xingchenfu.xyz/API/ndym.php' }, { name: 'bsxl', url: 'http://api.xingchenfu.xyz/API/bsxl.php' },
                { name: 'zzxjj', url: 'http://api.xingchenfu.xyz/API/zzxjj.php' }, { name: 'jk', url: 'http://api.xingchenfu.xyz/API/jk.php' },
                { name: 'meinv', url: 'https://v2.xxapi.cn/api/meinv?return=302' }, { name: 'jxhssp', url: 'https://api.jkyai.top/API/jxhssp.php' },
                { name: 'jxbssp', url: 'https://api.jkyai.top/API/jxbssp.php' }, { name: 'xjj', url: 'https://www.yx520.ltd/API/xjj/api.php?msg=xjj' },
                { name: 'jkllt', url: 'https://www.yx520.ltd/API/xjj/api.php?msg=jkllt' }, { name: 'llxl', url: 'https://www.yx520.ltd/API/xjj/api.php?msg=llxl' },
                { name: 'mhy', url: 'https://www.yx520.ltd/API/xjj/api.php?msg=mhy' }, { name: 'ndym-2', url: 'https://www.yx520.ltd/API/xjj/api.php?msg=ndym' },
                { name: 'rwsp-2', url: 'https://www.yx520.ltd/API/xjj/api.php?msg=rwsp' }, { name: 'sbkl', url: 'https://www.yx520.ltd/API/xjj/api.php?msg=sbkl' },
                { name: 'yz', url: 'https://www.yx520.ltd/API/xjj/api.php?msg=yz' }
            ];
            let allSources = [];

            // --- Core Video Logic ---
            const showLoading = () => loading.style.display = 'flex';
            const hideLoading = () => loading.style.display = 'none';
            
            function getVideoUrl() {
                const source = currentSource === 'random' 
                    ? allSources[Math.floor(Math.random() * allSources.length)]
                    : allSources.find(s => s.url === currentSource);
                
                const url = source ? source.url : allSources[0].url;
                const separator = url.includes('?') ? '&' : '?';
                return `${url}${separator}t=${Date.now()}`;
            }

            function loadNextVideo() {
                showLoading();
                resetTransform();
                videoPlayer.src = getVideoUrl();
                videoPlayer.loop = !autoPlayEnabled;
                videoPlayer.play().catch(()=>{});
            }

            // --- UI & Controls Logic ---
            function showControls() {
                clearTimeout(controlsTimer);
                controls.classList.add('visible');
            }

            function hideControls() {
                controls.classList.remove('visible');
            }

            function toggleControls() {
                if (controls.classList.contains('visible')) {
                    hideControls();
                } else {
                    showControls();
                    controlsTimer = setTimeout(hideControls, 3000); // 3ç§’åè‡ªåŠ¨éšè—
                }
            }

            function togglePlayPause() {
                videoPlayer.paused ? videoPlayer.play() : videoPlayer.pause();
            }

            // --- Transform Logic ---
            function updateTransform() {
                // é™åˆ¶å¹³ç§»èŒƒå›´ï¼Œé˜²æ­¢è§†é¢‘è¢«å®Œå…¨æ‹–å‡ºè§†é‡
                const maxTranslateX = (scale - 1) * videoPlayer.clientWidth / 2;
                const maxTranslateY = (scale - 1) * videoPlayer.clientHeight / 2;

                translateX = Math.max(-maxTranslateX, Math.min(maxTranslateX, translateX));
                translateY = Math.max(-maxTranslateY, Math.min(maxTranslateY, translateY));
                
                videoPlayer.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
            }

            function resetTransform() {
                scale = 1;
                translateX = 0;
                translateY = 0;
                updateTransform();
            }
            
            // --- Device-Specific Controls Initialization ---
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

            if (isTouchDevice) {
                initMobileControls();
            } else {
                initPcControls();
            }

            function initMobileControls() {
                let touchStartX, touchStartY, isSwiping, initialPinchDistance = 0, startScale = 1;
                let lastTapTime = 0, tapCount = 0;

                videoContainer.addEventListener('touchstart', e => {
                    if (e.target.closest('.modal-overlay') || e.target.closest('.controls')) return;
                    
                    if (e.touches.length === 1) {
                        touchStartX = e.touches[0].clientX;
                        touchStartY = e.touches[0].clientY;
                        isSwiping = false;

                        if (scale > 1) {
                            isDragging = true;
                            lastDragX = touchStartX;
                            lastDragY = touchStartY;
                        }
                    } else if (e.touches.length === 2) {
                        e.preventDefault();
                        isDragging = false; // åŒæŒ‡æ“ä½œæ—¶åœæ­¢æ‹–åŠ¨
                        initialPinchDistance = Math.hypot(
                            e.touches[0].clientX - e.touches[1].clientX,
                            e.touches[0].clientY - e.touches[1].clientY
                        );
                        startScale = scale;
                    }
                });

                videoContainer.addEventListener('touchmove', e => {
                    if (e.target.closest('.modal-overlay') || e.target.closest('.controls')) return;
                    e.preventDefault();

                    if (e.touches.length === 1 && isDragging) {
                        const deltaX = e.touches[0].clientX - lastDragX;
                        const deltaY = e.touches[0].clientY - lastDragY;
                        translateX += deltaX;
                        translateY += deltaY;
                        lastDragX = e.touches[0].clientX;
                        lastDragY = e.touches[0].clientY;
                        updateTransform();
                    } else if (e.touches.length === 1 && !isDragging) {
                         // åªæœ‰å½“æ²¡æœ‰æ‹–åŠ¨æ—¶ï¼Œæ‰åˆ¤æ–­ä¸ºæ»‘åŠ¨åˆ‡æ¢
                        const deltaX = Math.abs(e.touches[0].clientX - touchStartX);
                        const deltaY = Math.abs(e.touches[0].clientY - touchStartY);
                        if (deltaY > 10 && deltaY > deltaX) isSwiping = true;
                    } else if (e.touches.length === 2) {
                        const newPinchDistance = Math.hypot(
                            e.touches[0].clientX - e.touches[1].clientX,
                            e.touches[0].clientY - e.touches[1].clientY
                        );
                        scale = Math.max(1, startScale * (newPinchDistance / initialPinchDistance));
                        updateTransform();
                    }
                });

                videoContainer.addEventListener('touchend', e => {
                    if (e.touches.length > 0) return; // è¿˜æœ‰æ‰‹æŒ‡åœ¨å±å¹•ä¸Š

                    isDragging = false;
                    
                    // --- æ‰‹åŠ¿åˆ¤æ–­ ---
                    const touchEndX = e.changedTouches[0].clientX;
                    const touchEndY = e.changedTouches[0].clientY;
                    const deltaX = touchEndX - touchStartX;
                    const deltaY = touchEndY - touchStartY;
                    const absDeltaX = Math.abs(deltaX);
                    const absDeltaY = Math.abs(deltaY);

                    // 1. åˆ¤æ–­ä¸ºæ»‘åŠ¨ (ç§»åŠ¨è·ç¦»è¶…è¿‡é˜ˆå€¼)
                    if (isSwiping && absDeltaY > 50 && absDeltaY > absDeltaX) {
                        loadNextVideo();
                        return;
                    }

                    // 2. å¦‚æœä¸æ˜¯æ»‘åŠ¨ï¼Œåˆ¤æ–­ä¸ºç‚¹å‡»/åŒå‡»
                    if (absDeltaX < 10 && absDeltaY < 10) {
                        tapCount++;
                        setTimeout(() => {
                            if (tapCount === 1) { // å•å‡»
                                toggleControls();
                            } else if (tapCount === 2) { // åŒå‡»
                                togglePlayPause();
                            }
                            tapCount = 0;
                        }, 250); // 250mså†…å†æ¬¡ç‚¹å‡»ç®—åŒå‡»
                    }
                });
            }

            function initPcControls() {
                videoContainer.addEventListener('click', e => {
                    if (e.target.closest('.controls') || e.target.closest('.modal-overlay')) return;
                    togglePlayPause();
                    showControls();
                    controlsTimer = setTimeout(hideControls, 2000);
                });

                 videoContainer.addEventListener('mousedown', e => {
                    if (scale > 1) {
                        e.preventDefault();
                        isDragging = true;
                        lastDragX = e.clientX;
                        lastDragY = e.clientY;
                        videoContainer.style.cursor = 'grabbing';
                    }
                });

                videoContainer.addEventListener('mousemove', e => {
                    if (isDragging) {
                        const deltaX = e.clientX - lastDragX;
                        const deltaY = e.clientY - lastDragY;
                        translateX += deltaX;
                        translateY += deltaY;
                        lastDragX = e.clientX;
                        lastDragY = e.clientY;
                        updateTransform();
                    }
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                    videoContainer.style.cursor = 'pointer';
                });
                 videoContainer.addEventListener('mouseleave', () => {
                    isDragging = false;
                     videoContainer.style.cursor = 'pointer';
                });

                document.addEventListener('wheel', e => {
                    if (e.target.closest('.modal-overlay')) return;
                    
                    if (e.ctrlKey) { // Ctrl + æ»šè½®ç¼©æ”¾
                        e.preventDefault();
                        const scaleAmount = -e.deltaY * 0.001;
                        scale = Math.max(1, scale * (1 + scaleAmount));
                        updateTransform();
                    } else { // æ­£å¸¸æ»šè½®åˆ‡æ¢
                        if (e.deltaY !== 0) loadNextVideo();
                    }
                });

                document.addEventListener('keydown', e => {
                    if (e.target.tagName === 'INPUT') return;
                    if (e.key === 'ArrowDown' || e.key === 'ArrowUp') loadNextVideo();
                    if (e.key === ' ') { e.preventDefault(); togglePlayPause(); }
                });
            }
            
            // --- Source & Settings Modal Logic ---
            function loadSources() {
                const customSources = JSON.parse(localStorage.getItem('customVideoSources')) || [];
                allSources = [...DEFAULT_SOURCES, ...customSources.map(s => ({...s, isCustom: true}))];
            }

            function saveCustomSources(customSources) {
                localStorage.setItem('customVideoSources', JSON.stringify(customSources));
                loadSources();
                populateSourceList();
            }

            function populateSourceList() {
                sourceList.innerHTML = '';
                const randomLi = document.createElement('li');
                randomLi.textContent = 'ğŸ² éšæœºæº';
                randomLi.dataset.url = 'random';
                if (currentSource === 'random') randomLi.classList.add('active');
                sourceList.appendChild(randomLi);

                allSources.forEach(source => {
                    const li = document.createElement('li');
                    li.dataset.url = source.url;
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = source.name;
                    li.appendChild(nameSpan);
                    if (source.isCustom) {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'åˆ é™¤';
                        deleteBtn.className = 'delete-source-btn';
                        deleteBtn.onclick = (e) => {
                            e.stopPropagation();
                            if (confirm(`ç¡®å®šè¦åˆ é™¤æº "${source.name}" å—ï¼Ÿ`)) {
                                let customs = JSON.parse(localStorage.getItem('customVideoSources')) || [];
                                saveCustomSources(customs.filter(s => s.url !== source.url));
                            }
                        };
                        li.appendChild(deleteBtn);
                    }
                    if (currentSource === source.url) li.classList.add('active');
                    sourceList.appendChild(li);
                });
            }
            
            function setupModals() {
                settingsBtn.onclick = () => settingsModal.classList.add('visible');
                changeSourceBtn.onclick = () => {
                    populateSourceList();
                    sourceModal.classList.add('visible');
                };
                reloadBtn.onclick = loadNextVideo;

                [settingsModal, sourceModal].forEach(modal => {
                    modal.onclick = e => { if (e.target === modal) modal.classList.remove('visible'); };
                });

                downloadBtn.onclick = () => {
                    alert('æ­£åœ¨å°è¯•ä¸‹è½½... è¯·æ³¨æ„æµè§ˆå™¨å¯èƒ½ä¼šé˜»æ­¢å¼¹çª—ã€‚');
                    fetch(videoPlayer.src)
                        .then(response => {
                            if (!response.ok) throw new Error('ç½‘ç»œå“åº”å¤±è´¥ï¼Œå¯èƒ½å­˜åœ¨è·¨åŸŸä¿æŠ¤(CORS)ã€‚');
                            return response.blob();
                        })
                        .then(blob => {
                            const link = document.createElement('a');
                            link.href = URL.createObjectURL(blob);
                            link.download = `video_${Date.now()}.mp4`;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            URL.revokeObjectURL(link.href);
                        }).catch(err => alert(`ä¸‹è½½å¤±è´¥: ${err.message}`));
                };

                volumeSlider.oninput = e => videoPlayer.volume = e.target.value;
                
                autoplayToggle.onclick = () => {
                    autoPlayEnabled = !autoPlayEnabled;
                    videoPlayer.loop = !autoPlayEnabled;
                    autoplayToggle.textContent = autoPlayEnabled ? 'å¼€å¯' : 'å…³é—­';
                    autoplayToggle.classList.toggle('enabled', autoPlayEnabled);
                };

                sourceList.onclick = (e) => {
                    const li = e.target.closest('li');
                    if (!li || !li.dataset.url) return;
                    currentSource = li.dataset.url;
                    const source = allSources.find(s => s.url === currentSource);
                    changeSourceBtn.textContent = source ? source.name.substring(0, 4) : 'éšæœºæº'; // æŒ‰é’®åªæ˜¾ç¤ºå‰4ä¸ªå­—
                    sourceModal.classList.remove('visible');
                    loadNextVideo();
                };

                openAddSourceFormBtn.onclick = () => { addSourceForm.style.display = 'flex'; openAddSourceFormBtn.style.display = 'none'; };
                cancelAddSourceBtn.onclick = () => { addSourceForm.style.display = 'none'; openAddSourceFormBtn.style.display = 'block'; addSourceForm.reset(); };
                addSourceForm.onsubmit = (e) => {
                    e.preventDefault();
                    const name = document.getElementById('sourceNameInput').value.trim();
                    const url = document.getElementById('sourceUrlInput').value.trim();
                    if (!name || !url) return;
                    let customs = JSON.parse(localStorage.getItem('customVideoSources')) || [];
                    if (customs.some(s => s.url === url)) { alert('è¿™ä¸ªURLåœ°å€å·²ç»å­˜åœ¨äº†ï¼'); return; }
                    customs.push({ name, url });
                    saveCustomSources(customs);
                    cancelAddSourceBtn.click();
                };
            }
            
            // --- Player Event Listeners ---
            videoPlayer.addEventListener('loadeddata', hideLoading);
            videoPlayer.addEventListener('ended', () => autoPlayEnabled && loadNextVideo());
            videoPlayer.addEventListener('error', () => setTimeout(loadNextVideo, 1000));
            
            // --- Initialization ---
            function init() {
                loadSources();
                setupModals();
                loadNextVideo();
            }
            init();
        });
    </script>
</body>
</html>
